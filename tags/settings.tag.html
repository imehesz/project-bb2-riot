<settings>
  <div>
    <div title="Toggle Settings">
      <input type="checkbox" checked="{ui.on}" onchange="{toggleOn}"/> 
    </div>
    <div if={ui.on}>
      <h3>Settings</h3>
      <form>
        <label for="fromBook">From Book</label>
        <select id="fromBook" onChange="{fromBookChanged}">
          <option 
            each={languageOptions} 
            value={id} 
            disabled={settings.toBook==id}
            selected={settings.fromBook==id}>
              {label}
          </option>
        </select>
        <br />
        <label for="toBook">To Book</label>
        <select id="toBook" onchange="{toBookChanged}">
          <option 
            each={languageOptions} 
            value={id} 
            disabled={settings.fromBook==id}
            selected={settings.toBook==id}>
              {label}
          </option>
        </select>
        <br />
        <label for="theme">Theme</label>
        <select id="theme" onchange="{themeChanged}">
          <option each="{theme in themeOptions}" value="{theme}">{ui.capitalize(theme)}</option>
        </select>
        <br />
        <label for="showsecond">Show Second Book</label>
        <input type="checkbox" checked="{settings.showSecondBook}" onchange="{toggleSecondBook}"/>
      </form>
    </div>
    <hr>
  </div>

  <script>
    /* global M */
    /* global BB_SETTINGS */
    
    var self = this;
    var SETTINGS = typeof BB_SETTINGS != "undefined" ? BB_SETTINGS : {};
    
    self.ui = {
      on: false,
      capitalize: function(str) {
        return str[0].toUpperCase() + str.substr(1,str.length);
      }
    };
    
    this.languageOptions = SETTINGS.languageOptions || [
      {id: "asv", label: "American Standard Version (ASV)"},
      {id: "esv", label: "English Standard Version (ESV)"},
      {id: "nhun", label: "Hungarian (NEW)"},
      {id: "greek", label: "Greek"},
      {id: "moo", label: "Moo"}
    ];
    
    this.themeOptions = SETTINGS.themeOptions || ["light", "dark", "papyrus"];
    
    var defaults = {
      fromBook: "esv",
      toBook: "nhun",
      theme: "light",
      showSecondBook: true
    };
    
    if (M.Storage.get("settings")) {
      self.settings = $.extend({}, M.Storage.get("settings") );
    } else {
      self.settings = $.extend({}, defaults);
      M.Storage.set("settings", self.settings);
      M.Events.publish("settings_init", self.settings);
    }
    
    console.log(M.Storage.get("settings"));
    
    var oldSettings = JSON.stringify(self.settings);
    
    self.fromBookChanged = function(el) {
      self.settings.fromBook = $(el.target).val();
    };
    
    self.toBookChanged = function(el) {
      self.settings.toBook = $(el.target).val();
    };
    
    self.themeChanged = function(el) {
      self.settings.theme = $(el.target).val();
    };
    
    self.toggleSecondBook = function(el) {
      self.settings.showSecondBook = !self.settings.showSecondBook;
    };
    
    self.toggleOn = function() {
      self.ui.on = !self.ui.on;
      
      if (!self.ui.on && oldSettings != JSON.stringify(self.settings)) {
        console.log(JSON.parse(oldSettings), self.settings);
        
        // TODO save it to localstorage
        oldSettings = JSON.stringify(self.settings);
      }
    };
  </script>
</settings>