<settings>
  <div>
    <a 
      onclick={openModal}
      href="javascript:void(0);"  
      class="orange lighten-5">
        &#9881; SETTINGS
    </a>
    
    <div id="modal1" class="modal modal-fixed-footer">
      <div class="modal-content">
        <h4>Settings</h4>
        <p>
          <form class="col s12">
            <label for="fromBook">From Book</label>
            <select id="fromBook" onChange="{fromBookChanged}" class="browser-default">
              <option 
                each={languageOptions} 
                value={id} 
                disabled={settings.toBook==id}
                selected={settings.fromBook==id}>
                  {label}
              </option>
            </select>
    
            <label for="toBook">To Book</label>
            <select id="toBook" onchange="{toBookChanged}" class="browser-default">
              <option 
                each={languageOptions} 
                value={id} 
                disabled={settings.fromBook==id}
                selected={settings.toBook==id}>
                  {label}
              </option>
            </select>
            
            <label for="theme">Theme</label>
            <select id="theme" onchange="{themeChanged}" class="browser-default">
              <option each="{theme in themeOptions}" value="{theme}">{ui.capitalize(theme)}</option>
            </select>
    
    
            <label for="showsecond">Show Second Book</label>
            
            <!-- Switch -->
            <div class="switch">
              <label>
                Off
                <input 
                  onchange="{toggleSecondBook}"
                  checked="{settings.showSecondBook}" 
                  type="checkbox" />
                <span class="lever"></span>
                On
              </label>
            </div>
          </form>
        </p>
      </div>
      <div class="modal-footer">
        <a 
          onclick={save}
          href="javascript:void(0);" 
          class="modal-action modal-close waves-effect waves-green btn">
            Save
        </a>
    </div>
    </div>
  </div>

  <script>
    /* global M */
    /* global BB_SETTINGS */
    
    var self = this;
    var SETTINGS = typeof BB_SETTINGS != "undefined" ? BB_SETTINGS : {};
    
    self.ui = {
      capitalize: function(str) {
        return str[0].toUpperCase() + str.substr(1,str.length);
      }
    };
    
    this.languageOptions = SETTINGS.languageOptions || [
      {id: "asv", label: "American Standard Version (ASV)"},
      {id: "esv", label: "English Standard Version (ESV)"},
      {id: "nhun", label: "Hungarian (NEW)"},
      {id: "greek", label: "Greek"},
      {id: "moo", label: "Moo"}
    ];
    
    this.themeOptions = SETTINGS.themeOptions || ["light", "dark", "papyrus"];
    
    var defaults = {
      fromBook: "esv",
      toBook: "nhun",
      theme: "light",
      showSecondBook: true
    };
    
    if (M.Storage.get("settings")) {
      self.settings = $.extend({}, M.Storage.get("settings") );
    } else {
      self.settings = $.extend({}, defaults);
      M.Storage.set("settings", self.settings);
      M.Events.publish("settings_init", self.settings);
    }
    
    var oldSettings = JSON.stringify(self.settings);
    
    fromBookChanged(el) {
      self.settings.fromBook = $(el.target).val();
    };
    
    toBookChanged(el) {
      self.settings.toBook = $(el.target).val();
    };
    
    themeChanged(el) {
      self.settings.theme = $(el.target).val();
    };
    
    toggleSecondBook(el) {
      self.settings.showSecondBook = !self.settings.showSecondBook;
    };
    
    save() {
      if (oldSettings != JSON.stringify(self.settings)) {
        console.log(JSON.parse(oldSettings), self.settings);
        
        // TODO save it to localstorage
        oldSettings = JSON.stringify(self.settings);
        $("body").attr("class", self.settings.theme);
      }      
    }
    
    openModal() {
      $('#modal1').openModal();
    };
  </script>
</settings>